#!/bin/bash
# check-env-v4.sh - Validate .env.v4 for required vars and port conflicts
# Version: v4.0.1
# Updated: 2025-07-10 22:35 UTC

ENV_FILE="${1:-../.env.v4}"  # default to parent folder
REQUIRED_VARS=(
  V4_INGEST_PORT V4_DEVICE_MANAGER_PORT V4_ANALYTICS_PORT
  V4_CADDY_HTTP_PORT V4_CADDY_HTTPS_PORT V4_ADMINER_PORT
  V4_INGEST_DB_PORT V4_DEVICE_DB_PORT V4_ANALYTICS_DB_PORT
  V4_INGEST_DB_NAME V4_DEVICE_DB_NAME V4_ANALYTICS_DB_NAME
  V4_INGEST_DB_USER V4_INGEST_DB_PASSWORD
  V4_DEVICE_DB_USER V4_DEVICE_DB_PASSWORD
  V4_ANALYTICS_DB_USER V4_ANALYTICS_DB_PASSWORD
  V4_NETWORK_NAME V4_DOMAIN_ROOT V4_TLS_EMAIL
  UID GID
)

# ‚îÄ‚îÄ‚îÄ Load the env file ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if [[ ! -f $ENV_FILE ]]; then
  echo "‚ùå Env file $ENV_FILE not found"
  exit 1
fi

set -a
source "$ENV_FILE"
set +a

echo "üîç Validating required variables..."

# ‚îÄ‚îÄ‚îÄ Check for unset or empty vars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
MISSING_VARS=()
for var in "${REQUIRED_VARS[@]}"; do
  if [[ -z "${!var}" ]]; then
    MISSING_VARS+=("$var")
  fi
done

if [[ ${#MISSING_VARS[@]} -gt 0 ]]; then
  echo "‚ùå Missing required variables:"
  for var in "${MISSING_VARS[@]}"; do
    echo "   - $var"
  done
  exit 2
else
  echo "‚úÖ All required environment variables are set"
fi

# ‚îÄ‚îÄ‚îÄ Check for port conflicts on host ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo "üîç Checking for port conflicts..."
CONFLICTS=()
PORT_VARS=(V4_INGEST_PORT V4_DEVICE_MANAGER_PORT V4_ANALYTICS_PORT V4_CADDY_HTTP_PORT V4_CADDY_HTTPS_PORT V4_ADMINER_PORT V4_INGEST_DB_PORT V4_DEVICE_DB_PORT V4_ANALYTICS_DB_PORT)

for var in "${PORT_VARS[@]}"; do
  port="${!var}"
  if lsof -iTCP:"$port" -sTCP:LISTEN -Pn > /dev/null 2>&1; then
    CONFLICTS+=("$var ($port)")
  fi
done

if [[ ${#CONFLICTS[@]} -gt 0 ]]; then
  echo "‚ùå Port conflicts detected:"
  for item in "${CONFLICTS[@]}"; do
    echo "   - $item"
  done
  exit 3
else
  echo "‚úÖ No host port conflicts detected"
fi

echo "‚úÖ .env.v4 validation complete"
