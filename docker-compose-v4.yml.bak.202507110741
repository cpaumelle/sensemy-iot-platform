# docker-compose-v4.yml
# Version: v4.0.2
# Timestamp: 20250711-0917 UTC

services:
  ingest-service:
    container_name: ingest-service-v4
    build: ./01-ingest-server
    env_file:
      - .env.v4
    ports:
      - "${V4_INGEST_PORT}:8000"
    volumes:
      - ./01-ingest-server/app:/app
      - ./01-ingest-server/initdb:/docker-entrypoint-initdb.d
    networks:
      - sensemy_network

  device-manager:
    container_name: device-manager-v4
    build: ./02-device-manager
    env_file:
      - .env.v4
    ports:
      - "${V4_DEVICE_MANAGER_PORT}:9000"
    volumes:
      - ./02-device-manager/app:/app
      - ./02-device-manager/initdb:/docker-entrypoint-initdb.d
    networks:
      - sensemy_network

  analytics-alerts:
    container_name: analytics-alerts-v4
    build: ./03-analytics-alerts
    env_file:
      - .env.v4
    ports:
      - "${V4_ANALYTICS_PORT}:7000"
    volumes:
      - ./03-analytics-alerts/app:/app
      - ./03-analytics-alerts/initdb:/docker-entrypoint-initdb.d
    networks:
      - sensemy_network

  ingest-database:
    image: postgres:15
    container_name: ingest-database-v4
    env_file:
      - .env.v4
    volumes:
      - ingest-db-data-v4:/var/lib/postgresql/data
      - ./01-ingest-server/schema:/docker-entrypoint-initdb.d
    ports:
      - "${INGEST_DB_PORT}:5433"
    networks:
      - sensemy_network

  device-database:
    image: postgres:15
    container_name: device-database-v4
    env_file:
      - .env.v4
    volumes:
      - device-db-data-v4:/var/lib/postgresql/data
      - ./02-device-manager/schema:/docker-entrypoint-initdb.d
    ports:
      - "${DEVICE_DB_PORT}:5434"
    networks:
      - sensemy_network

  analytics-database:
    image: postgres:15
    container_name: analytics-database-v4
    env_file:
      - .env.v4
    volumes:
      - analytics-db-data-v4:/var/lib/postgresql/data
      - ./03-analytics-alerts/schema:/docker-entrypoint-initdb.d
    ports:
      - "${ANALYTICS_DB_PORT}:5435"
    networks:
      - sensemy_network

  iot-reverse-proxy:
    image: caddy:latest
    container_name: iot-reverse-proxy-v4
    ports:
      - "${V4_CADDY_HTTP_PORT}:80"
      - "${V4_CADDY_HTTPS_PORT}:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
    networks:
      - sensemy_network

volumes:
  ingest-db-data-v4:
  device-db-data-v4:
  analytics-db-data-v4:

networks:
  sensemy_network:
    external: true
