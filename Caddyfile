# Caddyfile - Version: 1.0.4 - 2025-07-09

{
    admin off
    log {
        output file /data/caddy-access.log
    }
}

# ─── API Backend ─────────────────────────────────────────────
api.sensemy.cloud {
    log {
        output file /data/api-access.log
    }
    reverse_proxy device-manager:9000
    tls chpa35@gmail.com
}

# ─── Devices API ─────────────────────────────────────────────
devices.sensemy.cloud {
    log {
        output file /data/devices-access.log
    }
    reverse_proxy device-manager:9000
    tls chpa35@gmail.com
}

# ─── Ingest API ──────────────────────────────────────────────
ingest.sensemy.cloud {
    log {
        output file /data/ingest-access.log
    }
    reverse_proxy ingest-service:8000
    tls chpa35@gmail.com
}

# ─── Analytics API ───────────────────────────────────────────
analytics.sensemy.cloud {
    log {
        output file /data/analytics-access.log
    }
    reverse_proxy analytics-receiver:7000
    tls chpa35@gmail.com
}

# ─── Tools (Adminer + Filebrowser) ───────────────────────────
tools.charliehub.net {
    log {
        output file /data/tools-access.log
    }
    encode gzip

    @adminer {
        path /adminer*
        path *.php
    }
    handle @adminer {
        reverse_proxy adminer-ui:8080
    }

    handle_path /files* {
        reverse_proxy filebrowser:80
    }

    handle {
        respond "🛠️ Tools Gateway Ready" 200
    }

    tls chpa35@gmail.com
}

# ─── UI (Versioned Static Routing) ──────────────────────────
app.sensemy.cloud {
    log {
        output file /data/app-access.log
    }

    redir / /v1/dashboard.html

    @version_static path_regexp version_static ^/v([1-9][0-9]*)/(.*)$

    handle @version_static {
        root * /srv/files/ui-versions/v6/src
        rewrite * /{http.regexp.version_static.2}
        file_server
    }

    tls chpa35@gmail.com
}
